<!doctype html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Szavazás</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            text-align: center;
            margin: 0;
            padding: 40px;
            min-height: 100vh;
        }

        h1 {
            margin-bottom: 40px;
        }

        #options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .option {
            width: 300px;
            padding: 20px;
            border-radius: 12px;
            background: white;
            color: #333;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .option:hover {
            transform: scale(1.05);
        }

        .disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        #waiting {
            margin-top: 30px;
            font-size: 18px;
            display: none;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <h1>Szavazz!</h1>
    <div id="options"></div>
    <div id="waiting">Várakozás a következő körre...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
    getDatabase,
    ref,
    onValue,
    update,
    increment,
    get,
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDmb4zgzbOlF_8KtjwaCJn3y_2DwYapqQk",
    authDomain: "talentum-nap.firebaseapp.com",
    databaseURL:
        "https://talentum-nap-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "talentum-nap",
    storageBucket: "talentum-nap.firebasestorage.app",
    messagingSenderId: "930243290620",
    appId: "1:930243290620:web:4ce6c75911ecd13ba4be79",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const optionsDiv = document.getElementById("options");
const waitingText = document.getElementById("waiting");

const kepek = [
    ["https://picsum.photos/300/200?1","https://picsum.photos/300/200?2","https://picsum.photos/300/200?3"],
    ["https://picsum.photos/300/200?4","https://picsum.photos/300/200?5","https://picsum.photos/300/200?6"],
    ["https://picsum.photos/300/200?7","https://picsum.photos/300/200?8","https://picsum.photos/300/200?9"],
    ["https://picsum.photos/300/200?10","https://picsum.photos/300/200?11","https://picsum.photos/300/200?12"],
];

let currentGroup = 0;
let hasVotedGroups = JSON.parse(localStorage.getItem("votedGroups") || "{}");

// Aktuális csoport figyelése
onValue(ref(db, "currentGroup"), (snapshot) => {
    currentGroup = snapshot.val() ?? 0;
    loadOptions(currentGroup);
});

// Reset figyelése
onValue(ref(db, "resetFlag"), (snapshot) => {
    if (snapshot.exists() && snapshot.val() === true) {
        hasVotedGroups = {};
        localStorage.removeItem("votedGroups");
        waitingText.style.display = "none";
        loadOptions(currentGroup);
    }
});

// Opciók betöltése
async function loadOptions(group) {
    optionsDiv.innerHTML = "";

    const hasVoted = !!hasVotedGroups[group];
    waitingText.style.display = hasVoted ? "block" : "none";

    const start = group * 3;
    const end = start + 3;

    for (let i = start; i < end; i++) {
        const snapshot = await get(ref(db, `options/${i}`));
        if (!snapshot.exists()) continue;

        const data = snapshot.val();
        const div = document.createElement("div");
        div.className = "option";

        const kepIndex = i - start;
        const kepUrl =
            kepek[group]?.[kepIndex] ||
            "https://via.placeholder.com/300x200?text=Nincs+kép";

        div.innerHTML = `
            <img src="${kepUrl}" 
                 alt="${data.text}" 
                 style="width:100%; height:180px; object-fit:cover; border-radius:8px; margin-bottom:12px;">
            <strong>${data.text}</strong><br>
            Szavazatok: ${data.votes || 0}
        `;

        if (hasVoted) {
            div.classList.add("disabled");
        } else {
            div.onclick = () => vote(i, group);
        }

        optionsDiv.appendChild(div);
    }
}

// Szavazás
function vote(index, group) {
    if (hasVotedGroups[group]) return;

    update(ref(db, `options/${index}`), { votes: increment(1) });

    hasVotedGroups[group] = true;
    localStorage.setItem("votedGroups", JSON.stringify(hasVotedGroups));

    document
        .querySelectorAll(".option")
        .forEach((el) => el.classList.add("disabled"));

    waitingText.style.display = "block";

    location.reload();
}
</script>
</body>
</html>
